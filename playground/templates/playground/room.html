<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Game Room</title>
</head>
<body>
    <div id="players"></div>
    <!--<textarea id="chat-log" cols="100" rows="20"></textarea><br/>
    <input id="chat-message-input" type="text" size="100"/><br/>
    <input id="chat-message-submit" type="button" value="Send"/>-->
    <input type='button' id='start-button' value='START' />
    <div id="useful"></div>
    <input type='button' id='ready-button' value='READY' />
    <div id="mywarzone"></div>
    <button onclick="setShip(1)">SHIP 1</button>
    <button onclick="setShip(2)">SHIP 2</button>
    <button onclick="setShip(3)">SHIP 3</button>
    <button onclick="setShip(4)">SHIP 4</button>
</body>
<script>
    var nowTurn;
    var myship1 = "{{ my_ship1 }}";
    var myship2 = "{{ my_ship2 }}";
    var myship3 = "{{ my_ship3 }}";
    var myship4 = "{{ my_ship4 }}";
    selectShip = 1;
    var gameStatus;
    var roomID = {{ room_id_json }};
    var gameSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/room/' + roomID + '/');
    
    gameSocket.onopen = function(e) {
        console.log('SocketOpen');
        gameSocket.send(JSON.stringify({
            'command':'refresh',
        }));
    };

    gameSocket.onmessage = function(e) {
        console.log('oyoyoyon');
        var data = JSON.parse(e.data);
        gameStatus = data['state'];
        loadplayers(data);
        loadMyWarzone("me");
        switch(data['state']){
            case 'preparation':
                break;
            case 'started':
                hideStartButton(data);
                loadEnemyWarzone(data);
                nowTurn = data['players'][data['players_mark'].indexOf(true)]['name']
                break;
            case 'finished':
                loadEnemyWarzone(data);
        }
    };

    gameSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
        alert("You're Disconnected, Please Reload");
    };
    
    function markplayers(game_state, marked){
        if (marked){
            switch(game_state){
                case 'preparation':
                    return "(Ready)";
                case 'started':
                    return "'s Turn";
                case 'finished':
                    return " is THE WINNER";
        }}
        return "";
    }

    function loadplayers(data){
        var players = data['players'];
        var mark = data['players_mark'];
        console.log(mark)
        document.getElementById('players').innerHTML = "";
        for(i=0;i<players.length;i++){
            document.getElementById('players').innerHTML += (players[i]['name']+markplayers(data['state'],mark[i])+"<br/>");
            }
    }

    function hideStartButton(data){
        document.getElementById('start-button').style.display="none";
        document.getElementById('ready-button').style.display="none";
    }

    function setShip(id){
        selectShip = id;
    }

    function renderColor(ship, name, color){
        shipid = [];
        num = ship.substr(1)%100;
        switch(ship){
            case(myship1):
                shiplen=5; break;
            case(myship2):
                shiplen=4; break;
            case(myship3):
                shiplen=3; break;
            case(myship4):
                shiplen=2; break;
        }
        if (ship[0]=='v'){
            for(i=0; i<shiplen; i++){
                shipid.push(num+i*7);
            }
        } else if (ship[0]=='h') {
            for(i=0; i<shiplen; i++){
                shipid.push(num+i);
            }
        }
        if (shipid.length!=0){
            for(c=0;c<shipid.length;c++){
                document.getElementById(name+'-'+shipid[c]).style.backgroundColor=color;
            }
        }
    }

    function pick(id){
        var idnya = id.split('-');
        var num = idnya[idnya.length-1]%100;
        if (gameStatus == 'preparation'){
            switch(selectShip){
                case 1:
                    if(myship1=="undefined" && num<=21){
                        myship1 = "v"+num;
                    } else if (num==myship1.substr(1)){
                        if (myship1[0]=='v' && 0<num%7 && num%7<=3) {
                            myship1="h"+num;
                            }
                        else if (myship1[0]=='h' && num<=21) {
                            myship1="v"+num;
                        }
                    } else if(myship1[0]=="v" && num<=21){
                        myship1 = "v"+num;
                    } else if(myship1[0]=='h' && 0<num%7 && num%7<=3) {
                        myship1 = "h"+num;
                    }
                    break;
                case 2:
                    if(myship2=="undefined" && num<=28){
                        myship2 = "v"+num;
                    } else if (num==myship2.substr(1)){
                        if (myship2[0]=='v' && 0<num%7 && num%7<=4) {
                            myship2="h"+num;
                            }
                        else if (myship2[0]=='h' && num<=28) {
                            myship2="v"+num;
                        }
                    } else if(myship2[0]=="v" && num<=28){
                        myship2 = "v"+num;
                    } else if(myship2[0]=='h' && 0<num%7 && num%7<=4) {
                        myship2 = "h"+num;
                    }
                    break;
                case 3:
                    if(myship3=="undefined" && num<=35){
                        myship3 = "v"+num;
                    } else if (num==myship3.substr(1)){
                        if (myship3[0]=='v' && 0<num%7 && num%7<=5) {
                            myship3="h"+num;
                            }
                        else if (myship3[0]=='h' && num<=35) {
                            myship3="v"+num;
                        }
                    } else if(myship3[0]=="v" && num<=35){
                        myship3 = "v"+num;
                    } else if(myship3[0]=='h' && 0<num%7 && num%7<=5) {
                        myship3 = "h"+num;
                    }
                    break;
                case 4:
                if(myship4=="undefined" && num<=42){
                        myship4 = "v"+num;
                    } else if (num==myship4.substr(1)){
                        if (myship4[0]=='v' && 0<num%7 && num%7<=6) {
                            myship4="h"+num;
                            }
                        else if (myship4[0]=='h' && num<=42) {
                            myship4="v"+num;
                        }
                    } else if(myship4[0]=="v" && num<=42){
                        myship4 = "v"+num;
                    } else if(myship4[0]=='h' && 0<num%7 && num%7<=6) {
                        myship4 = "h"+num;
                    }
                    break;
            }
            for(i=1; i<=49; i++){
                document.getElementById('me-'+i).style.backgroundColor='';
            }
            renderColor(myship1,'me','red');
            renderColor(myship2,'me','blue');
            renderColor(myship3,'me','yellow');
            renderColor(myship4,'me','green');
        }
    }

    
    function loadMyWarzone(owner){
        if (gameStatus == 'preparation'){
            var x="";
            for(i=1;i<=7;i++){
                x+="<tr>";
                for(j=1;j<=7;j++){
                    var iD = j+(i-1)*7;
                    x+="<td><input onclick=pick(id) value="+iD+" id="+owner+"-"+iD+" type='button'/></td>";
                }
                x+="</tr>";
            }
            document.querySelector('#mywarzone').innerHTML = "<table>"+x+"</table>";
        } else if(gameStatus == undefined){
            document.querySelector('#mywarzone').innerHTML = "Loading Data....";
        } else {
            var x="";
            for(i=1;i<=7;i++){
                x+="<tr>";
                for(j=1;j<=7;j++){
                    var iD = j+(i-1)*7;
                    x+="<td><input value="+iD+" id="+owner+"-"+iD+" type='button'/></td>";
                }
                x+="</tr>";
            }
            document.querySelector('#mywarzone').innerHTML = "<table>"+x+"</table>";
        }
        renderColor(myship1,owner,'red');
        renderColor(myship2,owner,'blue');
        renderColor(myship3,owner,'yellow');
        renderColor(myship4,owner,'green');
    }

    function loadEnemyWarzone(data){
        players = data['players'];
        document.getElementById('useful').innerHTML="";
        var x="";
        for (p=0; p<players.length; p++){
            x+="<table>";
            if(players[p]['name']!="{{request.user}}"){
                for(i=0; i<7; i++){
                    x+="<tr>";
                    for(j=1; j<=7; j++){
                        nom = players[p]['warzone_id'];
                        now_num = j+i*7
                        x+="<td><input onclick=attack(id) value="+now_num+" id="+players[p]['name']+"-"+now_num+" type='button'/></td>";
                    }
                    x+="</tr>";
                }
            }
            x+="</table>";
        }
        document.getElementById('useful').innerHTML = x;
        colorizeEnemy(data);
    }

    function colorizeEnemy(data){
        players = data['players']
        for (p=0; p<players.length; p++){
            if(players[p]['name']!="{{request.user}}"){
                for(i=0; i<7; i++){
                    for(j=1; j<=7; j++){
                        now_num = j+i*7
                        if(players[p]['shooted'].find((e)=>e==now_num)!=undefined){
                            document.getElementById(players[p]['name']+'-'+now_num).disabled = true;
                            document.getElementById(players[p]['name']+'-'+now_num).style.backgroundColor='grey';
                            if((players[p]['sh1_shooted'].find((e)=>e==now_num)!=undefined)||
                                (players[p]['sh2_shooted'].find((e)=>e==now_num)!=undefined)||
                                (players[p]['sh3_shooted'].find((e)=>e==now_num)!=undefined)||
                                (players[p]['sh4_shooted'].find((e)=>e==now_num)!=undefined)){
                                    document.getElementById(players[p]['name']+'-'+now_num).style.backgroundColor='black';}
                            if(players[p]['sh1_shooted'].length==5 && players[p]['sh1_shooted'].find((e)=>e==now_num)!=undefined){
                                document.getElementById(players[p]['name']+'-'+now_num).style.backgroundColor='red';}
                            if(players[p]['sh2_shooted'].length==4 && players[p]['sh2_shooted'].find((e)=>e==now_num)!=undefined){
                                document.getElementById(players[p]['name']+'-'+now_num).style.backgroundColor='blue';}
                            if(players[p]['sh3_shooted'].length==3 && players[p]['sh3_shooted'].find((e)=>e==now_num)!=undefined){
                                document.getElementById(players[p]['name']+'-'+now_num).style.backgroundColor='yellow';}
                            if(players[p]['sh4_shooted'].length==2 && players[p]['sh4_shooted'].find((e)=>e==now_num)!=undefined){
                                document.getElementById(players[p]['name']+'-'+now_num).style.backgroundColor='green';}
                        }
                    }
                }
            }
        }
    }

    function convertShipFormat(ship, num){
        if (ship[0]=="v"){
            var x = "v-"+ship.substr(1);
            for(i = 1; i<=num-1; i++){
                x+= "-"+((ship.substr(1)%100)+7*i);
            }
        } else{
            var x = "h-"+ship.substr(1);
            for(i = 1; i<=num-1; i++){
                x+= "-"+((ship.substr(1)%100)+1*i);
            }
        }
        return x;
    }

    function attack(id){
        console.log(id);
        if (nowTurn == "{{request.user}}"){
        gameSocket.send(JSON.stringify({
            'command': 'attack',
            'attacked_player': id.split('-')[0],
            'zone_id': id.split('-')[1],
            'room': roomID,
        }))} else {
            console.log('not your turn yet')
        }
    }

    document.querySelector('#start-button').onclick = function(e) {
        gameSocket.send(JSON.stringify({
            'command': 'start',
        }))
    };
    
    document.querySelector('#ready-button').onclick = function(e) {
        if ((myship1!=null)&&(myship2!=null)&&(myship3!=null)&&(myship4!==null)){
            gameSocket.send(JSON.stringify({
                'command': 'ready',
                'user': '{{request.user}}',
                'ship1': convertShipFormat(myship1, 5),
                'ship2': convertShipFormat(myship2, 4),
                'ship3': convertShipFormat(myship3, 3),
                'ship4': convertShipFormat(myship4, 2),
            }))
        } else {
            alert('diisi dulu');
        }
    };

    

    
    /*document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        var messageInputDom = document.querySelector('#chat-message-input');
        var message = messageInputDom.value;
        gameSocket.send(JSON.stringify({
            'command': 'new_message',
            'message': message,
        }));

        messageInputDom.value = '';
    };*/
</script>
</html>